<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司估值计算器 - DCF模型</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="app">
    <header class="header">
        <h1>📊 公司估值计算器</h1>
        <a href="wacc.html" class="nav-button">WACC 计算器</a>
    </header>

    <main class="container">
        <!-- 输入参数区域 -->
        <section class="input-section">
            <h2>🔧 计算参数</h2>
            
            <!-- 增长模式选择 -->
            <div class="growth-mode-selector">
                <label>增长模式：</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" v-model="growthMode" value="single">
                        <span>单阶段增长</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" v-model="growthMode" value="multi">
                        <span>多阶段增长</span>
                    </label>
                </div>
            </div>

            <!-- 单阶段增长输入 -->
            <div class="input-grid" v-if="growthMode === 'single'">
                <div class="input-group">
                    <label for="initialCashFlow">初始自由现金流 (万元)</label>
                    <input type="number" id="initialCashFlow" v-model.number="initialCashFlow" step="0.01" placeholder="例如：1000.50">
                </div>

                <div class="input-group">
                    <label for="growthRate">增长率 (%)</label>
                    <input type="number" id="growthRate" v-model.number="growthRate" step="0.1" placeholder="例如：10">
                </div>

                <div class="input-group">
                    <label for="years">预测年限</label>
                    <input type="number" id="years" v-model.number="years" placeholder="例如：5">
                </div>
            </div>

            <!-- 多阶段增长输入 -->
            <div class="multi-stage-input" v-if="growthMode === 'multi'">
                <div class="stage-header">
                    <h3>增长阶段设置</h3>
                    <button @click="addStage" class="add-stage-btn">+ 添加阶段</button>
                </div>
                
                <div v-for="(stage, index) in growthStages" :key="index" class="stage-item">
                    <div class="stage-header-info">
                        <h4>阶段 {{ index + 1 }}</h4>
                        <button v-if="growthStages.length > 1" @click="removeStage(index)" class="remove-stage-btn">删除</button>
                    </div>
                    <div class="stage-inputs">
                        <div class="input-group">
                            <label>阶段名称</label>
                            <input type="text" v-model="stage.name" placeholder="例如：高速增长期">
                        </div>
                        <div class="input-group">
                            <label>持续年限</label>
                            <input type="number" v-model.number="stage.years" min="1" placeholder="例如：3">
                        </div>
                        <div class="input-group">
                            <label>年增长率 (%)</label>
                            <input type="number" v-model.number="stage.growthRate" step="0.1" placeholder="例如：15">
                        </div>
                    </div>
                </div>
                
                <div class="input-group multi-initial-cashflow">
                    <label for="initialCashFlow">初始自由现金流 (万元)</label>
                    <input type="number" id="initialCashFlow" v-model.number="initialCashFlow" step="0.01" placeholder="例如：1000.50">
                </div>
            </div>

            <!-- 通用参数 -->
            <div class="input-grid common-params">
                <div class="input-group">
                    <label for="discountRate">折现率 (%)</label>
                    <input type="number" id="discountRate" v-model.number="discountRate" step="0.1" placeholder="例如：12">
                </div>

                <div class="input-group">
                    <label for="terminalGrowth">永续增长率 (%)</label>
                    <input type="number" id="terminalGrowth" v-model.number="terminalGrowth" step="0.1" placeholder="例如：3">
                </div>

                <div class="input-group">
                    <label for="shareCapital">总股本（万股）</label>
                    <input type="number" id="shareCapital" v-model.number="shareCapital" step="0.01" placeholder="例如：10000.50">
                </div>
            </div>

            <button @click="calculateDCF" class="calculate-btn">开始计算</button>
        </section>

        <!-- 结果显示区域 -->
        <section class="results-section" v-if="results.calculated">
            <h2>📈 计算结果</h2>

            <div class="summary-cards">
                <div class="card">
                    <h3>公司估值</h3>
                    <p class="value">{{ formatCurrency(results.companyValue) }} 万元</p>
                </div>
                <div class="card">
                    <h3>经营价值</h3>
                    <p class="value">{{ formatCurrency(results.operatingValue) }} 万元</p>
                </div>
                <div class="card">
                    <h3>终值</h3>
                    <p class="value">{{ formatCurrency(results.terminalValue) }} 万元</p>
                </div>
                <div class="card">
                    <h3>每股合理价格</h3>
                    <p class="value">{{ formatCurrency(results.stockPrice) }} 元</p>
                </div>
            </div>

            <!-- 在表格上方添加说明 -->
            <div class="table-container">
                <h3>年度现金流明细
                    <span class="info-icon" title="点击查看公式说明" @click="showFormulaHelp = !showFormulaHelp">ℹ️</span>
                </h3>

                <!-- 公式帮助提示 -->
                <div v-if="showFormulaHelp" class="formula-help">
                    <h4>计算公式说明：</h4>
                    <div v-if="growthMode === 'single'">
                        <h5>单阶段增长模式：</h5>
                        <ul>
                            <li><strong>自由现金流</strong> = 初始现金流 × (1 + 增长率)<sup>年份</sup></li>
                            <li><strong>折现因子</strong> = (1 + 折现率)<sup>年份</sup></li>
                            <li><strong>现值</strong> = 自由现金流 ÷ 折现因子</li>
                            <li><strong>累计现值</strong> = 当前年及之前所有年份的现值之和</li>
                        </ul>
                    </div>
                    <div v-if="growthMode === 'multi'">
                        <h5>多阶段增长模式：</h5>
                        <ul>
                            <li><strong>阶段内现金流</strong> = 上期现金流 × (1 + 阶段增长率)</li>
                            <li><strong>折现因子</strong> = (1 + 折现率)<sup>年份</sup></li>
                            <li><strong>现值</strong> = 自由现金流 ÷ 折现因子</li>
                            <li><strong>累计现值</strong> = 当前年及之前所有年份的现值之和</li>
                            <li><strong>跨阶段计算</strong> = 前一阶段最后一年现金流作为下一阶段基数</li>
                        </ul>
                    </div>
                    <h5>终值计算（通用）：</h5>
                    <ul>
                        <li><strong>终值</strong> = [最后一年现金流 × (1 + 永续增长率)] ÷ (折现率 - 永续增长率)</li>
                    </ul>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>年份</th>
                        <th>阶段</th>
                        <th>自由现金流</th>
                        <th>增长率</th>
                        <th>折现因子</th>
                        <th>现值</th>
                        <th>累计现值</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="year in results.yearlyData" :key="year.year"
                        :class="{ 'terminal-row': year.isTerminal }">
                        <td>{{ year.year }}</td>
                        <td>{{ year.stage || '-' }}</td>
                        <td>{{ formatCurrency(year.cashFlow) }}</td>
                        <td>{{ year.growthRate ? year.growthRate.toFixed(1) + '%' : '-' }}</td>
                        <td>{{ year.discountFactor.toFixed(4) }}</td>
                        <td>{{ formatCurrency(year.presentValue) }}</td>
                        <td>{{ formatCurrency(year.cumulativePV) }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- 图表展示 -->
            <div class="chart-container">
                <h3>现金流趋势</h3>
                <canvas id="cashFlowChart" ref="chartCanvas"></canvas>
            </div>
        </section>

        <!-- 说明区域 -->
        <section class="explanation-section">
            <h2>💡 DCF模型说明</h2>
            <!-- 在 explanation-section 中替换或添加以下内容 -->
            <div class="explanation-content">
                <h3>什么是经营价值？</h3>
                <p>经营价值是指公司在预测期内（如前5年）所有自由现金流的现值总和。它反映了公司核心业务在可预测期间内创造的价值，不包括终值。</p>

                <h3>DCF计算分解：</h3>
                <div class="formula">
                    <p><strong>公司总价值 = 经营价值 + 终值现值</strong></p>
                    <p>经营价值 = ∑ [第1年到第n年的现金流现值]</p>
                    <p>终值现值 = 终值 / (1 + 折现率)^n</p>
                </div>

                <h3>终值计算详解</h3>
                <div class="terminal-value-explanation">
                    <p>终值代表预测期结束后公司永续经营阶段的价值，使用戈登增长模型计算：</p>

                    <div class="formula">
                        <p><strong>终值 = [第n年现金流 × (1 + 永续增长率)] ÷ (折现率 - 永续增长率)</strong></p>
                        <p>其中：</p>
                        <ul>
                            <li><strong>第n年现金流</strong>：预测期最后一年的自由现金流</li>
                            <li><strong>永续增长率</strong>：公司长期稳定的增长率，通常接近GDP增长率</li>
                            <li><strong>折现率</strong>：投资者的要求回报率，反映风险水平</li>
                        </ul>
                    </div>

                    <div class="formula-example">
                        <h4>计算示例：</h4>
                        <p>假设：</p>
                        <ul>
                            <li>第5年现金流：1,610.51万元</li>
                            <li>永续增长率：3%</li>
                            <li>折现率：12%</li>
                        </ul>
                        <p>终值 = 1,610.51 × (1 + 3%) ÷ (12% - 3%) = 1,658.83 ÷ 9% = 18,431.44万元</p>
                        <p>终值现值 = 18,431.44 ÷ (1 + 12%)^5 = 18,431.44 ÷ 1.7623 = 10,459.22万元</p>
                    </div>
                </div>

                <h3>核心公式：</h3>
                <div class="formula">
                    <p>公司价值 = ∑ [第t年现金流 / (1 + 折现率)^t] + 终值 / (1 + 折现率)^n</p>
                </div>

                <h3>参数说明：</h3>
                <ul>
                    <li><strong>自由现金流</strong>: 公司经营活动产生的可自由支配的现金</li>
                    <li><strong>增长率</strong>: 预期现金流的年均增长率</li>
                    <li><strong>折现率</strong>: 反映投资风险的预期回报率</li>
                    <li><strong>永续增长率</strong>: 预测期后的长期稳定增长率，通常为2%-4%</li>
                </ul>

                <h3>注意事项：</h3>
                <ul>
                    <li>永续增长率必须小于折现率，否则公式不成立</li>
                    <li>永续增长率通常不应超过长期GDP增长率</li>
                    <li>终值通常占公司总价值的很大比例（50%-70%）</li>
                    <li>高增长公司的终值比例可能更高</li>
                </ul>
            </div>
        </section>
        <!-- 在输入参数区域后添加 -->
        <section class="cashflow-guide">
            <h2>💡 如何查找公司现金流数据</h2>

            <div class="guide-steps">
                <div class="step">
                    <h3>步骤1：找到现金流量表</h3>
                    <p>在公司的年报或季报中，找到<strong>现金流量表</strong>（不是利润表或资产负债表）</p>
                </div>

                <div class="step">
                    <h3>步骤2：定位关键数据</h3>
                    <div class="data-points">
                        <div class="data-point">
                            <span class="label">经营活动现金流量净额：</span>
                            <span class="value">直接查找这个数字</span>
                        </div>
                        <div class="data-point">
                            <span class="label">资本支出：</span>
                            <span class="value">查找"购建固定资产支付的现金"</span>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <h3>步骤3：计算自由现金流</h3>
                    <div class="formula-card">
                        <p class="formula">自由现金流 = 经营活动现金流量净额 - 资本支出</p>
                        <div class="example">
                            <p><strong>示例：</strong></p>
                            <p>经营活动现金流量净额：1,000万元</p>
                            <p>资本支出：200万元</p>
                            <p class="result">自由现金流 = 1,000 - 200 = 800万元</p>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <h3>步骤4：常用数据源</h3>
                    <div class="data-sources">
                        <div class="source">
                            <h4>A股公司</h4>
                            <ul>
                                <li>东方财富网</li>
                                <li>新浪财经</li>
                                <li>巨潮资讯网</li>
                            </ul>
                        </div>
                        <div class="source">
                            <h4>美股公司</h4>
                            <ul>
                                <li>Yahoo Finance</li>
                                <li>Google财经</li>
                                <li>公司官网Investor Relations</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="quick-tips">
                <h3>💡 快速提示</h3>
                <ul>
                    <li>使用<strong>最近12个月</strong>的数据，不要只用年度数据</li>
                    <li>关注现金流趋势，而不仅仅是单期数字</li>
                    <li>比较同行业公司的现金流水平</li>
                    <li>警惕经营活动现金流长期为负的公司</li>
                </ul>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>© 2024 公司估值计算器 |
            <a :href="githubRepo" target="_blank">GitHub仓库</a> |
            数据仅供参考，投资需谨慎
        </p>
    </footer>
</div>

<script src="app.js"></script>
</body>
</html>